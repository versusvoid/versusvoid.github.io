<html>
    <head>
        <meta charset="utf-8">
        <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.css" />
        <!--[if lte IE 8]>
            <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.ie.css" />
        <![endif]-->
        <script src="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.js"></script>
        <script>
        function get_random_color() {
            var letters = '0123456789ABCDEF'.split('');
            var color = '#';
            for (var i = 0; i < 6; i++ ) {
                color += letters[Math.round(Math.random() * 15)];
            }
            return color;
        }
        
        var idToIndex = {};
        var vertexies = new Array();

        var trafficColors = ["#000000",
                "#00FF00",
                "#66FF33",
                "#CCFF00",
                "#CCFF33",
                "#FFFF33",
                "#FFFF00",
                "#FFCC33",
                "#FFCC00",
                "#FF6600",
                "#FF3300",
                "#FF0000"];

        var map;
        
        function initMap()
        {
            var apiKey = '460a360c630e43849b9f1ede2511e713';
            
            map = L.map('map').setView([59.96231, 30.30836],13);
            L.tileLayer('http://{s}.tile.cloudmade.com/' + apiKey + '/999/256/{z}/{x}/{y}.png', {
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>',
                maxZoom: 18
            }).addTo(map);

/*
            var polyline = L.polyline([new L.LatLng(59.91, 30.304), new L.LatLng(59.941, 30.314031)], {color: 'red', opacity: 1}).addTo(map);

            setTimeout(function(){
                polyline.setStyle({color: 'green', opactity: 1});
            }, 5000);
            var polygon = L.polygon([
                [59.96575, 30.23369],
                [59.96506, 30.27420],
                [59.96747, 30.28090],
                [59.97228, 30.28467],
                [59.98038, 30.31467],
                [59.97623, 30.32656],
                [59.96996, 30.33411],
                [59.95346, 30.34012],
                [59.94532, 30.30446],
                [59.96326, 30.23403]
            ]).addTo(map);
            
            map.fitBounds(polygon.getBounds());
*/
            var popup = L.popup();

            function onMapClick(e) {
                popup
                    .setLatLng(e.latlng)
                    .setContent("You clicked the map at " + e.latlng.toString())
                    .openOn(map);
            }

            map.on('click', onMapClick);
        
            $.getJSON('ways.json', onMapLoaded);
        }

        function onMapLoaded(json) 
        {
            var ways = {};
            for(var i = 0; i < json.elements.length; i++)
            {
                if( json.elements[i].type === "way" )
                {
                    ways[json.elements[i].id] = json.elements[i];
                }
                else if( json.elements[i].type === "node" )
                {
                    idToIndex[json.elements[i].id] = vertexies.length;
                    vertexies[vertexies.length] = json.elements[i];
                    delete vertexies[vertexies.length - 1]['type']; // потому что не нужен
                    delete vertexies[vertexies.length - 1]['id'];   // потому что не нужен
                    vertexies[vertexies.length - 1]['edges'] = new Array();
                }
            }

            for( wayId in ways )
            {
                var way = ways[wayId];
               for(var i = 0; i < way.nodes.length - 1; i++)
               {
                   if( way.nodes[i] in idToIndex && 
                        way.nodes[i + 1] in idToIndex )
                   {
                       var v1 = vertexies[idToIndex[way.nodes[i]]];
                       var v2id = idToIndex[way.nodes[i + 1]];
                       var v2 = vertexies[v2id];
                       var points = [new L.LatLng(v1.lat, v1.lon), new L.LatLng(v2.lat, v2.lon)];
                       var polyline = L.polyline(points, {color: trafficColors[1], opacity: 0.75}).addTo(map);
 
                       v1['edges'].push({'ind':v2id, 'load': 1, 'line': polyline});
                   }
                   else
                   {
                       console.warn(way);
                       console.warn(way.nodes[i]);
                       console.warn(way.nodes[i + 1]);
                   }
               }
            }
/*
            var count = 0;
            for(var j = 0; j < json.elements.length && count < 10000; count++ )
            {
                var nodes = new Array();
                var baseJ = j;
                for(var i = 0; json.elements[j].type === "node" && i < 100000; i++, j++)
                {
                    nodes[i] = json.elements[j].id;
                }
               
                var points = new Array();
                for( var i = 0; i < json.elements[j].nodes.length; i++ ){
                    for( var k = 0; k < nodes.length; k++) {
                        if( json.elements[j].nodes[i] == nodes[k] ){
                            points[i] = new L.LatLng(json.elements[baseJ + k].lat, json.elements[baseJ + k].lon);
                            break;
                        }
                    }
                }

                var polyline = L.polyline(points, {color: get_random_color(), opacity: 0.75}).addTo(map);
        
                polyline.on('click', function(inJ){ return (function(){console.log(json.elements[inJ]);}); }(j));
                
                while( j < json.elements.length && json.elements[j].type !== "node" )
                    j++;
            }
            console.log(count + " ways");
*/
        }
        </script>
    <head>
    <body onload="initMap()">
        void-void
        <br />
        <br />
        <div id="map" style="height: 600px"></div>

        <table width="100%">
            <tr>
                <td bgcolor="00FF00">&nbsp;</td>
                <td bgcolor="66FF33">&nbsp;</td>
                <td bgcolor="CCFF00">&nbsp;</td>
                <td bgcolor="CCFF33">&nbsp;</td>
                <td bgcolor="FFFF33">&nbsp;</td>
                <td bgcolor="FFFF00">&nbsp;</td>
                <td bgcolor="FFCC33">&nbsp;</td>
                <td bgcolor="FFCC00">&nbsp;</td>
                <td bgcolor="FF6600">&nbsp;</td>
                <td bgcolor="FF3300">&nbsp;</td>
                <td bgcolor="FF0000">&nbsp;</td>
            </tr>
        </table>
    </body>
</html>
