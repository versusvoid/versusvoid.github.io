<html>
    <head>
        <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.css" />
        <!--[if lte IE 8]>
            <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.ie.css" />
        <![endif]-->
        <script src="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.js"></script>
        <script>
        function get_random_color() {
            var letters = '0123456789ABCDEF'.split('');
            var color = '#';
            for (var i = 0; i < 6; i++ ) {
                color += letters[Math.round(Math.random() * 15)];
            }
            return color;
        }
        function initMap()
        {
            var apiKey = '460a360c630e43849b9f1ede2511e713';
            
            var cloudmadeUrl = 'http://{s}.tile.cloudmade.com/' + apiKey + '/{styleId}/256/{z}/{x}/{y}.png',
                cloudmadeAttribution = 'Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2011 CloudMade';
            var motorways = L.tileLayer(cloudmadeUrl, {styleId: 46561, attribution: cloudmadeAttribution}),
                midnight  = L.tileLayer(cloudmadeUrl, {styleId: 999,   attribution: cloudmadeAttribution});
            var map = L.map('map', {
                center: new L.LatLng(59.956271, 30.310031),
                zoom: 9,
                layers: [midnight, motorways]
            });

            var overlayMaps = {
                "Motorways": motorways,
            };

            L.control.layers({}, overlayMaps).addTo(map);
/*
            var polyline = L.polyline([new L.LatLng(59.91, 30.304), new L.LatLng(59.941, 30.314031)], {color: 'red', opacity: 1}).addTo(map);

            setTimeout(function(){
                polyline.setStyle({color: 'green', opactity: 1});
            }, 5000);
*/
            var polygon = L.polygon([
                [59.96575, 30.23369],
                [59.96506, 30.27420],
                [59.96747, 30.28090],
                [59.97228, 30.28467],
                [59.98038, 30.31467],
                [59.97623, 30.32656],
                [59.96996, 30.33411],
                [59.95346, 30.34012],
                [59.94532, 30.30446],
                [59.96326, 30.23403]
            ]).addTo(map);
            
            map.fitBounds(polygon.getBounds());

            var popup = L.popup();

            function onMapClick(e) {
                popup
                    .setLatLng(e.latlng)
                    .setContent("You clicked the map at " + e.latlng.toString())
                    .openOn(map);
            }

            map.on('click', onMapClick);
        
            $.getJSON('ways.json', function(json) {
                var count = 0;
                for(var j = 0; j < json.elements.length && count < 10000; count++ )
                {
                    var nodes = new Array();
                    var baseJ = j;
                    for(var i = 0; json.elements[j].type === "node" && i < 100000; i++, j++)
                    {
                        nodes[i] = json.elements[j].id;
                    }
                    if( json.elements[j].type !== "way") 
                        console.warning("Not way " + j);
                   
                    var points = new Array();
                    for( var i = 0; i < json.elements[j].nodes.length; i++ ){
                        for( var k = 0; k < nodes.length; k++) {
                            if( json.elements[j].nodes[i] == nodes[k] ){
                                points[i] = new L.LatLng(json.elements[baseJ + k].lat, json.elements[baseJ + k].lon);
                                break;
                            }
                        }
                    }

                    var polyline = L.polyline(points, {color: get_random_color(), opacity: 0.75}).addTo(map);
            
                    polyline.on('click', function(inJ){ return (function(){console.log(json.elements[inJ]);}); }(j));
                    
                    while( j < json.elements.length && json.elements[j].type !== "node" )
                        j++;
                }
                console.log(count);
            });
        }
        </script>
    <head>
    <body onload="initMap()">
        void-void
        <br />
        <br />
        <br />
        <br />
        <br />
        <br />
        <br />
        <br />
        <br />
        <br />
        <br />
        <div id="map" style="height: 480px"></div>
    </body>
</html>
