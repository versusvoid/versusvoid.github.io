<html>
    <head>
        <meta charset="utf-8">
        <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.css" />
        <!--[if lte IE 8]>
            <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.ie.css" />
        <![endif]-->
        <script src="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.js"></script>
        <script>
            function get_random_color()
            {
                var letters = '0123456789ABCDEF'.split('');
                var color = '#';
                for (var i = 0; i < 6; i++)
                {
                    color += letters[Math.round(Math.random() * 15)];
                }
                return color;
            }

            var idToIndex = {};
            var vertexies = new Array();

            var trafficColors = [
                {
                    color: "#000000"
                },
                {
                    color: "#00FF00"
                },
                {
                    color: "#33FF00"
                },
                {
                    color: "#66FF00"
                },
                {
                    color: "#99FF00"
                },
                {
                    color: "#CCFF00"
                },
                {
                    color: "#FFFF00"
                },
                {
                    color: "#FFCC00"
                },
                {
                    color: "#FF9900"
                },
                {
                    color: "#FF6600"
                },
                {
                    color: "#FF3300"
                },
                {
                    color: "#FF0000"
                }
            ];

            var map;

            var popup = L.popup();

            function onMapClick(e)
            {
                popup
                    .setLatLng(e.latlng)
                    .setContent("You clicked the map at " + e.latlng.toString())
                    .openOn(map);
            }


            function initMap()
            {
                var apiKey = '460a360c630e43849b9f1ede2511e713';

                map = L.map('map')
                    .setView([59.96231, 30.30836], 13);
                L.tileLayer('http://{s}.tile.cloudmade.com/' + apiKey + '/999/256/{z}/{x}/{y}.png',
                {
                    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>',
                    maxZoom: 18
                })
                    .addTo(map);

                /*
				var polyline = L.polyline([new L.LatLng(59.91, 30.304), new L.LatLng(59.941, 30.314031)],
                {
                    color: 'red',
                    opacity: 1
                })
                    .addTo(map);

                setTimeout(function ()
                {
                    polyline.setStyle(
                    {
                        color: 'green',
                        opactity: 1
                    });
                }, 5000);
                var polygon = L.polygon([
                [59.96575, 30.23369],
                 [59.96506, 30.27420],
                 [59.96747, 30.28090],
                 [59.97228, 30.28467],
                 [59.98038, 30.31467],
                 [59.97623, 30.32656],
                 [59.96996, 30.33411],
                 [59.95346, 30.34012],
                 [59.94532, 30.30446],
                 [59.96326, 30.23403]
                ])
                    .addTo(map);

                map.fitBounds(polygon.getBounds());
				*/

                map.on('click', onMapClick);

                $.getJSON('ways.json', onMapLoaded);
            }

            function onMapLoaded(json)
            {
                var ways = {};
                for (var i = 0; i < json.elements.length; i++)
                {
                    if (json.elements[i].type === "way")
                    {
                        ways[json.elements[i].id] = json.elements[i];
                    }
                    else if (json.elements[i].type === "node")
                    {
                        idToIndex[json.elements[i].id] = vertexies.length;
                        vertexies[vertexies.length] = json.elements[i];
                        delete vertexies[vertexies.length - 1]['type']; // потому что не нужен
                        delete vertexies[vertexies.length - 1]['id']; // потому что не нужен
                        vertexies[vertexies.length - 1].edges = new Array();
                    }
                }

                for (wayId in ways)
                {
                    var way = ways[wayId];
                    var isOneWay = way['tags']['oneway'] === 'yes';
                    for (var i = 0; i < way.nodes.length - 1; i++)
                    {
                        if (way.nodes[i] in idToIndex &&
                            way.nodes[i + 1] in idToIndex)
                        {
                            var v1id = idToIndex[way.nodes[i]];
                            var v1 = vertexies[v1id];
                            var v2id = idToIndex[way.nodes[i + 1]];
                            var v2 = vertexies[v2id];
                            var points = [new L.LatLng(v1.lat, v1.lon), new L.LatLng(v2.lat, v2.lon)];
                            var polyline = L.polyline(points,
                            {
                                color: trafficColors[1].color,
                                opacity: 0.75
                            })
                                .addTo(map);
                            polyline.on('click', function (inV1Id, inV2Id, isBidirect)
                            {
                                return (function (e)
                                {
                                    console.log("Click on edge from " + inV1Id + " to " + inV2Id + (isBidirect?" bidirect":" directed"));
                                    edgeClicked(e, inV1Id, inV2Id, isBidirect);
                                });
                            }(v1id, v2id, isOneWay));



                            var edge = {
                                'ind1': v1id,
                                'ind2': v2id,
                                'load': 1,
                                'line': polyline,
                                'ver': 0,
                                'used': false
                            };
                            v1.edges.push(edge);
                            if( !isOneWay )
                            {
                                v2.edges.push(edge);
                            }
                        }
                        else
                        {
                            console.warn(way);
                            console.warn(way.nodes[i]);
                            console.warn(way.nodes[i + 1]);
                        }
                    }
                }

                /*
                var count = 0;
                for (var j = 0; j < json.elements.length && count < 10000; count++)
                {
                    var nodes = new Array();
                    var baseJ = j;
                    for (var i = 0; json.elements[j].type === "node" && i < 100000; i++, j++)
                    {
                        nodes[i] = json.elements[j].id;
                    }

                    var points = new Array();
                    for (var i = 0; i < json.elements[j].nodes.length; i++)
                    {
                        for (var k = 0; k < nodes.length; k++)
                        {
                            if (json.elements[j].nodes[i] == nodes[k])
                            {
                                points[i] = new L.LatLng(json.elements[baseJ + k].lat, json.elements[baseJ + k].lon);
                                break;
                            }
                        }
                    }

                    var polyline = L.polyline(points,
                    {
                        color: get_random_color(),
                        opacity: 0.75
                    })
                        .addTo(map);

                    polyline.on('click', function (inJ)
                    {
                        return (function ()
                        {
                            console.log(json.elements[inJ]);
                        });
                    }(j));

                    while (j < json.elements.length && json.elements[j].type !== "node")
                        j++;
                }
                console.log(count + " ways");
				*/
            }

            var path = {source: null, selectingSource: false, dest: undefined, selectingDest: false, line: null};
            function selectSource()
            {
                path.selectingSource = true;
                path.selectingDest = false;
            }
            function selectDest()
            {
                path.selectingDest = true;
                path.selectingSource = false;
            }
            function edgeClicked(e, v1id, v2id, isBidirect)
            {
                if( path.selectingSource )
                {
                    if( path.source != null )
                    {
                        map.removeLayer(path.source.marker);
                        delete path.source.marker;
                        path.source = null;
                    }
                    else
                    {
                        path.source = {marker: null, edge: null};
                    }
                    if( isBidirect )
                    {
                        var x1 = vertexies[v1id].lat - e.latlng.lat;
                        var y1 = vertexies[v1id].lon - e.latlng.lon;
                        var x2 = vertexies[v2id].lat - e.latlng.lat;
                        var y2 = vertexies[v2id].lon - e.latlng.lon;
                        if( x1*x1 + y1*y1 < x2*x2 + y2*y2 )
                        {
                            path.source.edge = {v1: v1id, v2: v2id};
                        }
                        else
                        {
                            path.source.edge = {v1: v2id, v2: v1id};
                        }
                    }
                    else
                    {
                        path.source.edge = {v1: v1id, v2: v2id};
                    }
                    path.source.marker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
                    path.selectingSource = false;
                }
                else if( path.selectingDest )
                {
                    if( path.dest != null )
                    {
                        map.removeLayer(path.dest.marker);
                        delete path.dest.marker;
                        path.dest = null;
                    }
                    else
                    {
                        path.dest = {marker: null, edge: null};
                    }
                    if( isBidirect )
                    {
                        var x1 = vertexies[v1id].lat - e.latlng.lat;
                        var y1 = vertexies[v1id].lon - e.latlng.lon;
                        var x2 = vertexies[v2id].lat - e.latlng.lat;
                        var y2 = vertexies[v2id].lon - e.latlng.lon;
                        if( x1*x1 + y1*y1 < x2*x2 + y2*y2 )
                        {
                            path.dest.edge = {v1: v1id, v2: v2id};
                        }
                        else
                        {
                            path.dest.edge = {v1: v2id, v2: v1id};
                        }
                    }
                    else
                    {
                        path.dest.edge = {v1: v1id, v2: v2id};
                    }
                    path.dest.marker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
                    path.selectingDest = false;
                }
                else
                {
                    onMapClick(e);
                }
            }

            function findPath()
            {
                if( path.source === null || path.dest === null )
                    return;

                var vert = new Array();
                vert[0] = path.source.v1;
                var lengthes = new Array(vertexies.length);
                for(var i = 0; i < lengthes.length; i++)
                {
                    lengthes[i] = Number.POSITIVE_INFINITY;
                    for( var j = 0; j < vertexies[i].edges.length; j++ )
                    	vertexies[i].edges[j]['used'] = false;
                }

                while( vert.length > 0 )
                {
                    for( var i = 0; i < )
                }
            }
            
            var timeoutId;
            function switchUpdating()
            {
                if( timeoutId !== undefined )
                {
                    console.log("Updating stopped");
                    clearTimeout(timeoutId);
                    timeoutId = undefined;
                    $("#switch").text("Start updating");
                }
                else
                {
                    console.log("Updating started");
                    timeoutId = setTimeout(updateMap, 5000);
                    $("#switch").text("Stop updating");
                }
                
            }

            var iteration = 0;

            function updateMap()
            {
                var newVer;
                for (var i = 0; i < vertexies.length; i++)
                {
                    if (vertexies[i].edges.length > 0)
                    {
                        newVer = vertexies[i].edges[0]['ver'] + 1;
                        break;
                    }
                }
                var updated = 0;
                for (var i = 0; i < vertexies.length; i++)
                {
                    var edges = vertexies[i].edges;
                    for (var j = 0; j < edges.length; j++)
                    {
                        if (edges[j]['ver'] !== newVer)
                        {
                            var newLoad = Math.round(edges[j]['load'] + (Math.random() * 4 - 2));
                            if (newLoad < 1)
                            {
                                newLoad = 1;
                            }
                            else if (newLoad > 10)
                            {
                                newLoad = 10;
                            }

                            if (newLoad !== edges[j]['load'])
                            {
                                updated++;

                                edges[j]['load'] = newLoad;
                                edges[j]['line'].setStyle(trafficColors[newLoad]);
                            }

                            edges[j]['ver'] = newVer;
                        }
                    }
                }
                console.log("Iteration:" + iteration + ", updated edges: " + updated);
                iteration++;
                if( timeoutId !== undefined )
                {
                    timeoutId = setTimeout(updateMap, 5000);
                }
            }
        </script>
    </head>
    <body onload="initMap()">
        <button id="switch" onclick="switchUpdating()">Start updating</button>
        <br />
        <button id="starter" onclick="selectSource()">Select start</button>
        <button id="dester" onclick="selectDest()">Select destination</button>
        <div id="map" style="height: 600px"></div>
        <table width="100%">
            <tr>
                <td bgcolor="00FF00">&nbsp;</td>
                <td bgcolor="33FF00">&nbsp;</td>
                <td bgcolor="66FF00">&nbsp;</td>
                <td bgcolor="99FF00">&nbsp;</td>
                <td bgcolor="CCFF00">&nbsp;</td>
                <td bgcolor="FFFF00">&nbsp;</td>
                <td bgcolor="FFCC00">&nbsp;</td>
                <td bgcolor="FF9900">&nbsp;</td>
                <td bgcolor="FF6600">&nbsp;</td>
                <td bgcolor="FF3300">&nbsp;</td>
                <td bgcolor="FF0000">&nbsp;</td>
            </tr>
        </table>
    </body>
</html>
